<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CW Decoder Test</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            background: #1a1a1a;
            color: #0f0;
        }
        h1 {
            color: #0f0;
            border-bottom: 2px solid #0f0;
            padding-bottom: 10px;
        }
        .config {
            background: #2a2a2a;
            padding: 15px;
            border: 1px solid #0f0;
            border-radius: 5px;
            margin: 20px 0;
        }
        .config input {
            width: 300px;
            padding: 5px;
            margin: 5px 0;
            background: #1a1a1a;
            color: #0f0;
            border: 1px solid #0f0;
        }
        .config button {
            background: #0f0;
            color: #000;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-weight: bold;
            margin: 10px 5px;
        }
        .config button:hover {
            background: #0c0;
        }
        .config button:disabled {
            background: #555;
            color: #888;
            cursor: not-allowed;
        }
        .status {
            background: #2a2a2a;
            padding: 10px;
            border: 1px solid #0f0;
            border-radius: 5px;
            margin: 10px 0;
        }
        .status.connected {
            border-color: #0f0;
        }
        .status.disconnected {
            border-color: #f00;
            color: #f00;
        }
        .decoded {
            background: #000;
            padding: 20px;
            border: 2px solid #0f0;
            border-radius: 5px;
            min-height: 100px;
            font-size: 24px;
            font-weight: bold;
            letter-spacing: 2px;
            margin: 20px 0;
        }
        .log {
            background: #000;
            padding: 15px;
            border: 1px solid #555;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
            color: #888;
        }
        .log-entry {
            margin: 2px 0;
        }
        .log-entry.debug {
            color: #666;
        }
        .log-entry.info {
            color: #0af;
        }
        .log-entry.warn {
            color: #fa0;
        }
        .log-entry.error {
            color: #f00;
        }
    </style>
</head>
<body>
    <h1>ðŸ”Š CW Decoder Test</h1>
    
    <div class="config">
        <h3>Configuration</h3>
        <label>Server URL:</label><br>
        <input type="text" id="serverUrl" value="ws://localhost:8788"><br>
        <label>Callsign:</label><br>
        <input type="text" id="callsign" value="TEST"><br>
        <label>Room ID:</label><br>
        <input type="text" id="roomId" value="main"><br>
        <button id="connectBtn" onclick="connect()">Connect</button>
        <button id="disconnectBtn" onclick="disconnect()" disabled>Disconnect</button>
        <button onclick="clearDecoded()">Clear Display</button>
    </div>
    
    <div class="status disconnected" id="status">
        âš« Disconnected
    </div>
    
    <div class="decoded" id="decoded">
        <em>Decoded text will appear here...</em>
    </div>
    
    <div class="log" id="log">
        <div class="log-entry info">Console log...</div>
    </div>
    
    <script src="js/cw-decoder.js"></script>
    <script>
        let ws = null;
        let decoder = new CWDecoder();
        let logCount = 0;
        const MAX_LOG_ENTRIES = 100;
        
        // Set up decoder callbacks
        decoder.onDecodedChar = (callsign, char, wpm) => {
            const decodedDiv = document.getElementById('decoded');
            if (decodedDiv.innerHTML.includes('<em>')) {
                decodedDiv.innerHTML = '';
            }
            
            if (char === ' ') {
                decodedDiv.innerHTML += '<span style="color: #ff0;"> </span>';
            } else {
                decodedDiv.innerHTML += char;
            }
            
            log(`Decoded: ${char} (${wpm} WPM)`, 'info');
            
            // Auto-scroll to bottom
            decodedDiv.scrollTop = decodedDiv.scrollHeight;
        };
        
        decoder.onWordSpace = (callsign) => {
            const decodedDiv = document.getElementById('decoded');
            decodedDiv.innerHTML += ' ';
            log('Word space detected', 'info');
        };
        
        function connect() {
            const serverUrl = document.getElementById('serverUrl').value;
            const callsign = document.getElementById('callsign').value;
            const roomId = document.getElementById('roomId').value;
            
            log(`Connecting to ${serverUrl}...`, 'info');
            
            ws = new WebSocket(serverUrl + '?room=' + roomId);
            
            ws.onopen = () => {
                log('WebSocket connected', 'info');
                updateStatus(true);
                
                // Send join message
                const joinMsg = {
                    type: 'join',
                    roomId: roomId,
                    callsign: callsign
                };
                ws.send(JSON.stringify(joinMsg));
                log('Sent join message', 'info');
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                log(`Received: ${data.type}`, 'debug');
                
                if (data.type === 'cw_event') {
                    log(`CW Event from ${data.callsign}: ${data.key_down ? 'DOWN' : 'UP'} ${data.duration_ms}ms`, 'info');
                    decoder.processEvent(data);
                } else if (data.type === 'joined') {
                    log(`Joined room ${data.roomId} as ${data.peerId}`, 'info');
                } else if (data.type === 'peer_joined') {
                    log(`${data.callsign} joined`, 'info');
                } else if (data.type === 'peer_left') {
                    log(`${data.callsign} left`, 'info');
                }
            };
            
            ws.onerror = (error) => {
                log(`WebSocket error: ${error}`, 'error');
            };
            
            ws.onclose = () => {
                log('WebSocket disconnected', 'warn');
                updateStatus(false);
            };
        }
        
        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }
        
        function updateStatus(connected) {
            const statusDiv = document.getElementById('status');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            
            if (connected) {
                statusDiv.className = 'status connected';
                statusDiv.innerHTML = 'ðŸŸ¢ Connected';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            } else {
                statusDiv.className = 'status disconnected';
                statusDiv.innerHTML = 'âš« Disconnected';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            }
        }
        
        function clearDecoded() {
            document.getElementById('decoded').innerHTML = '<em>Decoded text will appear here...</em>';
        }
        
        function log(message, level = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${level}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            
            // Limit log entries
            logCount++;
            if (logCount > MAX_LOG_ENTRIES) {
                logDiv.removeChild(logDiv.firstChild);
                logCount--;
            }
            
            // Auto-scroll to bottom
            logDiv.scrollTop = logDiv.scrollHeight;
            
            // Also log to console
            console.log(`[${level.toUpperCase()}] ${message}`);
        }
        
        // Initialize
        log('CW Decoder Test initialized', 'info');
        log('Timing thresholds: ditDah=1.5x, letter=3.5x, word=6.0x', 'info');
    </script>
</body>
</html>
